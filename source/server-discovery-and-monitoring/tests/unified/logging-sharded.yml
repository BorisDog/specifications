description: "sharded-logging"

schemaVersion: "1.14"

runOnRequirements:
  - topologies:
      - sharded
    minServerVersion: "4.4" # awaitable hello

createEntities:
  - client:
      id: &setupClient setupClient
      useMultipleMongoses: false

tests:
  - description: "Topology lifecycle"
    operations:
      - name: createEntities
        object: testRunner
        arguments:
          entities:
            - client:
                id: &client client
                observeLogMessages:
                  topology: debug
                observeEvents:
                  - topologyDescriptionChangedEvent
                useMultipleMongoses: true
      # ensure the topology has been fully discovered before closing the client.
      - name: waitForEvent
        object: testRunner
        arguments:
          client: *client
          event:
            topologyDescriptionChangedEvent: {}
          count: 3
      - name: close
        object: *client
    expectLogMessages:
      - client: *client
        ignoreLogMessages:
          - data:
              message: "Starting server monitoring"
          - data:
              message: "Server heartbeat started"
          - data:
              message: "Server heartbeat succeeded"
          - data:
              message: "Server heartbeat failed"
        messages:
          - level: debug
            component: topology
            data:
              message: "Starting topology monitoring"
              topologyId: { $$exists: true }
          - level: debug
            component: topology
            data:
              message: "Topology description changed"
              topologyId: { $$exists: true }
              previousDescription:  { $$exists: true }
              newDescription: { $$exists: true }
          - level: debug
            component: topology
            data:
              message: "Topology description changed"
              topologyId: { $$exists: true }
              previousDescription:  { $$exists: true }
              newDescription: { $$exists: true }
          - level: debug
            component: topology
            data:
              message: "Topology description changed"
              topologyId: { $$exists: true }
              previousDescription:  { $$exists: true }
              newDescription: { $$exists: true }
          - level: debug
            component: topology
            data:
              message: "Stopped server monitoring"
              topologyId: { $$exists: true }
              serverHost: { $$type: string }
              serverPort: { $$type: [int, long] }
          - level: debug
            component: topology
            data:
              message: "Stopped server monitoring"
              topologyId: { $$exists: true }
              serverHost: { $$type: string }
              serverPort: { $$type: [int, long] }
          - level: debug
            component: topology
            data:
              message: "Topology description changed"
              topologyId: { $$exists: true }
              previousDescription:  { $$exists: true }
              newDescription: { $$exists: true }
          - level: debug
            component: topology
            data:
              message: "Stopped topology monitoring"
              topologyId: { $$exists: true }
  - description: Succefull hearbeat
    operations:
      - name: createEntities
        object: testRunner
        arguments:
          entities:
          - client:
              id: *client
              observeLogMessages:
                topology: debug
              observeEvents:
              - serverHeartbeatSucceededEvent
              uriOptions:
                heartbeatFrequencyMS: 500
      - name: waitForEvent
        object: testRunner
        arguments:
          client: *client
          event:
            serverHeartbeatSucceededEvent: {}
          count: 3
    expectLogMessages:
      - client: *client
        ignoreExtraLogs: true
        ignoreLogMessages:
          - data:
              message: "Server heartbeat started"
          - data:
              message: "Starting server monitoring"
          - data:
              message: "Stopped server monitoring"
          - data:
              message: "Topology description changed"
        messages:
          - level: debug
            component: topology
            data:
              message: "Starting topology monitoring"
              topologyId: { $$exists: true }
          - level: debug
            component: topology
            data:
              message: "Server heartbeat succeeded"
              awaited: { $$exists: true }
              topologyId: { $$exists: true }
              serverHost: { $$type: string }
              serverPort: { $$type: [int, long] }
              driverConnectionId: { $$exists: true }
              serverConnectionId: { $$exists: true }
              durationMS: { $$type: [int, long] }
              reply:
                $$matchAsDocument:
                  "$$matchAsRoot":
                    ok: 1
          - level: debug
            component: topology
            data:
              message: "Server heartbeat succeeded"
              awaited: { $$exists: true }
              topologyId: { $$exists: true }
              serverHost: { $$type: string }
              serverPort: { $$type: [int, long] }
              driverConnectionId: { $$exists: true }
              serverConnectionId: { $$exists: true }
              durationMS: { $$type: [int, long] }
              reply:
                $$matchAsDocument:
                  "$$matchAsRoot":
                    ok: 1
          - level: debug
            component: topology
            data:
              message: "Server heartbeat succeeded"
              awaited: { $$exists: true }
              topologyId: { $$exists: true }
              serverHost: { $$type: string }
              serverPort: { $$type: [int, long] }
              driverConnectionId: { $$exists: true }
              serverConnectionId: { $$exists: true }
              durationMS: { $$type: [int, long] }
              reply:
                $$matchAsDocument:
                  "$$matchAsRoot":
                    ok: 1
  - description: Failing hearbeat
    operations:
    - name: createEntities
      object: testRunner
      arguments:
        entities:
        - client:
            id: *client
            observeLogMessages:
              topology: debug
            observeEvents:
            - serverHeartbeatStartedEvent
            - serverHeartbeatFailedEvent
            uriOptions:
              heartbeatFrequencyMS: 500
              appname: failingHeartbeatLoggingTest
    - name: failPoint
      object: testRunner
      arguments:
        failPoint:
          configureFailPoint: failCommand
          mode:
            times: 2
          data:
            failCommands:
            - hello
            - isMaster
            appName: failingHeartbeatLoggingTest
            closeConnection: true
        client: setupClient
    - name: waitForEvent
      object: testRunner
      arguments:
        client: *client
        event:
          serverHeartbeatFailedEvent: {}
        count: 1
    expectLogMessages:
    - client: *client
      ignoreExtraLogs: true
      ignoreLogMessages:
        - data:
            message: "Server heartbeat started"
        - data:
            message: "Server heartbeat succeeded"
        - data:
            message: "Starting server monitoring"
        - data:
            message: "Stopped server monitoring"
        - data:
            message: "Topology description changed"
      messages:
      - level: debug
        component: topology
        data:
          message: "Starting topology monitoring"
          topologyId:
            "$$exists": true
      - level: debug
        component: topology
        data:
          message: "Server heartbeat failed"
          awaited: { $$exists: true }
          topologyId: { $$exists: true }
          serverHost: { $$type: string }
          serverPort: { $$type: [int, long] }
          driverConnectionId: { $$exists: true }
          serverConnectionId: { $$exists: true }
          durationMS: { $$type: [int, long] }
          failure: { $$exists: true }